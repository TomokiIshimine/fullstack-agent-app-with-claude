---
argument-hint: "Issue番号（例: #42, 42）またはバグの説明を入力してください"
description: 単一のバグを調査・修正し、PR作成まで行う。
---
ultrathink

# バグ修正ワークフロー

単一のバグを調査・設計・修正・レビュー・PR作成まで一気通貫で実行する。
`develop_feature` より軽量で、`resolve_top_issues` より丁寧（ユーザー確認ゲートあり）。

## ユーザーの入力
`$ARGUMENTS`

## 準備

### Step 0-1: 入力解析

`$ARGUMENTS` を解析して入力タイプを判定する:

- **Issue番号**（`#42`, `42` など数字を含む）→ Bash ツールで `gh issue view {番号} --json number,title,body,labels` を実行し、Issue の詳細を取得する
- **フリーテキスト** → そのままバグの説明として使用する

### Step 0-2: ブランチと作業ディレクトリの作成

1. 今日の日付（YYYY-MM-DD）と入力内容から短い説明（kebab-case）を決定する
2. 作業ディレクトリ `tasks/YYYY-MM-DD-fix-{短い説明}/` を作成する
3. ブランチを作成する:
   - Issue番号あり → `git checkout -b fix/issue-{N}-{短い説明}`
   - Issue番号なし → `git checkout -b fix/{短い説明}`

---

## ワークフロー全体像

```
Phase 1: 調査・設計 → ユーザー確認
┌─────────────────────────────────────────────┐
│ Phase 2〜3 ループ（レビュー通過まで、最大3回）│
│ Phase 2: 実装 + テスト                       │
│ Phase 3: コードレビュー → 問題あれば2へ      │
└─────────────────────────────────────────────┘
→ ユーザー確認
Phase 4: E2Eテスト（条件付き） → 失敗なら Phase 2 に戻る（最大2回）
Phase 5: PR作成
```

---

## Phase 1: 調査・設計

**エージェント:** `system-designer`

Task ツールで `system-designer` を起動し、バグの原因調査と修正設計を行う:

> 以下のバグについて調査し、修正方針を設計してください。
>
> **バグ情報:**
> {Issue の場合: Issue #{number}: {title} + 本文 / フリーテキストの場合: ユーザーの説明}
>
> 出力先パス: `tasks/YYYY-MM-DD-fix-{短い説明}/BugAnalysis.md`
>
> BugAnalysis.md には以下を含めること:
> 1. **原因分析**: バグの根本原因（関連コードを読んで特定すること）
> 2. **影響ファイル一覧**: 変更が必要なファイルパスのリスト
> 3. **修正方針**: 各ファイルで何をどう変更するか
> 4. **テスト方針**: 既存テストの修正 or 新規テスト追加の要否と内容
> 5. **リスク**: 他機能への影響の有無
> 6. **E2Eテスト判定**: 以下の基準で「推奨」または「不要」を明記する
>    - 推奨: UI操作に関わるバグ、複数画面に影響するバグ、ユーザーフローに影響するバグ
>    - 不要: バックエンドのみの変更、ロジックバグ、単体テストで十分なバグ
>
> CLAUDE.md と既存コードを読んでプロジェクトのパターンに従うこと。

成果物の保存を確認したら、**ユーザーに BugAnalysis.md の内容を提示し、承認を求める。**

承認されたら Phase 2 へ。修正指示があれば `system-designer` を resume して対応する。

---

## Phase 2: 実装 + テスト

**エージェント:** `backend-implementer` / `frontend-implementer`

BugAnalysis.md の影響ファイル一覧からスコープを判定する:
- `backend/` 配下のファイルが含まれる → `backend-implementer`
- `frontend/` 配下のファイルが含まれる → `frontend-implementer`
- 両方 → `backend-implementer` → `frontend-implementer` の順に逐次実行

### Step 2-1: 実装

スコープに応じたエージェントを Task ツールで起動する:

**backend-implementer:**
> BugAnalysis `tasks/YYYY-MM-DD-fix-{短い説明}/BugAnalysis.md` を読み込み、修正方針に従ってバグを修正してください。
>
> backend/CLAUDE.md のパターンに厳密に従うこと。
> テスト方針に従ってテストも追加・修正すること。

**frontend-implementer:**
> BugAnalysis `tasks/YYYY-MM-DD-fix-{短い説明}/BugAnalysis.md` を読み込み、修正方針に従ってバグを修正してください。
>
> frontend/CLAUDE.md のパターンに厳密に従うこと。
> テスト方針に従ってテストも追加・修正すること。

### Step 2-2: テスト実行

Bash ツールでスコープに応じたテストを実行する:
- バックエンド: `make test-backend`
- フロントエンド: `make test-frontend`
- 両方: `make test`

**テストが失敗した場合:** 失敗内容を分析し、該当スコープのエージェントを再起動して修正する。修正後に再テスト。テスト修正ループは **最大2回** まで。

### Step 2-3: フォーマット

`make format` を実行してコードを整形する。

---

## Phase 3: コードレビュー

**エージェント:** `code-reviewer` ×並列

### Step 3-1: 変更スコープの分析

`git diff main` で変更ファイルを確認し、適切なレビュースコープに分割する。

### Step 3-2: 並列レビュー実行

各スコープごとに `code-reviewer` を **並列で** Task ツールから起動する:

> 以下のスコープの変更をレビューしてください。
>
> **スコープ**: {対象パス}
> **バグ修正内容**: {BugAnalysis.md の概要}
>
> ファイルへの保存は不要です。レビュー結果はそのままレスポンスとして返してください。
> Must Fix（重大問題）があれば明確に示してください。

### Step 3-3: レビュー結果の判定

- **Must Fix がある場合:** 問題を修正して Phase 2 に戻る（ループは最大3回まで）
- **Must Fix がない場合:** Phase 2〜3 ループを抜ける

---

### ユーザー確認ゲート（Phase 2〜3 完了後）

実装内容・テスト結果・レビュー結果のサマリーをユーザーに提示し、**承認を求める。**

承認されたら次へ。修正指示があれば Phase 2 に戻って対応する。

---

## Phase 4: E2Eテスト（条件付き）

**BugAnalysis.md の「E2Eテスト判定」が「推奨」の場合のみ実行する。「不要」の場合は Phase 5 へスキップする。**

**エージェント:** `e2e-test-prep` → `e2e-test-runner`

### Step 4-0: 環境準備

Task ツールで `e2e-test-prep` を起動し、E2Eテスト実行に必要な環境準備を行う。

### Step 4-1: テストシナリオ設計と実行

バグの再現手順と修正確認をカバーする最小限のテストシナリオを設計し、`e2e-test-runner` を起動する:

> 以下のバグ修正を検証するE2Eテストを実行してください。
>
> **バグ内容**: {BugAnalysis.md の原因分析の概要}
> **修正内容**: {BugAnalysis.md の修正方針の概要}
> **検証ポイント**: バグが再現しないこと、修正後の正常動作
>
> テスト結果の保存先: `tasks/YYYY-MM-DD-fix-{短い説明}/test-results/`

### Step 4-2: テスト結果の判定

- **失敗した場合:** 失敗原因を分析し、Phase 2 に戻って修正する。E2E起因の Phase 2 戻りは **最大2回** まで。超過した場合はユーザーに状況を報告して判断を仰ぐ。
- **成功した場合:** Phase 5 へ。

---

## Phase 5: PR作成

**エージェント:** `pull-request-creator`

Task ツールで `pull-request-creator` を起動する:

> 現在のブランチの変更内容をもとに PR を作成してください。
> lint / format / test を全チェックしてから PR を作成し、CI の結果を監視してください。
> {Issue番号がある場合: PR 本文に `Closes #{issue_number}` を含めてください。}

PR の URL をユーザーに報告してワークフロー完了。

---

## ループ制御ルール

- Phase 2〜3 の実装・レビューループは **最大3回** まで。3回でもレビューが通らない場合はユーザーに報告し、判断を仰ぐ。
- Phase 4 のE2E失敗による Phase 2 戻りは **最大2回** まで。超過した場合はユーザーに報告し、判断を仰ぐ。
- 各 Phase でエラーが発生した場合は、エラー内容をユーザーに報告して指示を仰ぐ。
- ユーザー確認ゲートでは、必ず成果物のサマリーを提示してから承認を求める。

## エラーハンドリング

- **`gh` コマンドの認証エラー**: ユーザーに `gh auth login` の実行を促してワークフローを停止する
- **Issue が見つからない**: ユーザーに Issue 番号の確認を求める
- **ブランチ作成失敗**（既存ブランチ名の衝突など）: ブランチ名にタイムスタンプを付与してリトライする
- **エージェント起動失敗**: エラー内容をユーザーに報告して指示を仰ぐ
