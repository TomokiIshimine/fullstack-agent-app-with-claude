---
description: docs/05_e2e-test-cases.md の全テストケースを一括実行し、結果をサマリーレポートにまとめる。
allowed-tools: Bash(mkdir*), Bash(date*), Read(**), Task(e2e-test-prep), Task(e2e-test-runner)
---
ultrathink

# 全E2Eテスト一括実行ワークフロー

`docs/05_e2e-test-cases.md` に定義された全テストケースを順次実行し、結果をサマリーレポートにまとめる。

---

## Phase 1: 準備

### Step 1-1: テストケースの読み込み

`docs/05_e2e-test-cases.md` を読み込み、全テストケース（ID・テスト名・画面/パス・前提条件・操作手順・期待結果）を抽出する。カテゴリの順序とテストIDの順序を維持すること。

### Step 1-2: 結果保存ディレクトリの作成

今日の日付（YYYY-MM-DD）を取得し、結果保存ディレクトリを作成する:

```bash
mkdir -p test-results/YYYY-MM-DD
```

### Step 1-3: 環境準備

Task ツールで `e2e-test-prep` エージェントを起動し、E2Eテスト実行に必要な環境準備（サービス起動・ヘルスチェック・DBマイグレーション・テストアカウント作成・フロントエンド疎通確認）を行う。

- **準備成功**: Phase 2 へ進む
- **準備失敗**: エージェントのレポートをユーザーに提示して **ワークフローを停止** する

---

## Phase 2: テスト実行

Step 1-1 で抽出した全テストケースを、カテゴリ順・ID順に **1つずつ** 実行する。

### 重要: 逐次実行ルール

**`e2e-test-runner` は必ず1つずつ起動すること。複数の `e2e-test-runner` を同時に起動してはならない。** 1つのテストが完了してから次のテストを起動する。

### 各テストの実行方法

各テストケースについて、Task ツールで `e2e-test-runner` エージェントを **1つだけ** 起動する。プロンプトには以下を含める:

> `docs/05_e2e-test-cases.md` のテストケース **{テストID}**「{テスト名}」を実行してください。
>
> **保存先ディレクトリ**: `test-results/YYYY-MM-DD/{テストID}/`
>
> テストケース詳細:
> - **画面/パス**: {画面/パス}
> - **前提条件**: {前提条件}
> - **操作手順**: {操作手順}
> - **期待結果**: {期待結果}

### 失敗時の挙動

テストが失敗しても **残りのテストを全て継続実行する**。各テストの結果（PASS/FAIL）を内部で集計しておく。

### 進捗報告

カテゴリの全テストが完了するごとに、現在の進捗をユーザーに簡潔に報告する:

> ✅ {カテゴリ名}: X/Y PASS（累計: XX/YY）

---

## Phase 3: 結果集約・レポート

全テスト完了後、以下を行う:

### Step 3-1: 結果の集約

各テストの `test-results/YYYY-MM-DD/{テストID}/report.md` を読み取り、結果（PASS/FAIL）を集約する。

### Step 3-2: サマリーレポートの作成

`test-results/YYYY-MM-DD/summary.md` に以下のフォーマットでサマリーレポートを保存する。カテゴリ・テストIDの一覧は Step 1-1 で抽出した内容に基づいて動的に生成する:

```markdown
# E2E テスト実行サマリー

**実行日時**: YYYY-MM-DD
**結果**: ✅ XX PASS / ❌ XX FAIL（全 N 件）

## カテゴリ別結果

| カテゴリ | テスト数 | PASS | FAIL | 結果 |
|---------|---------|------|------|------|
| {カテゴリ名} | X | X | X | ✅/❌ |
| ... | | | | |
| **合計** | **N** | **X** | **X** | |

## テスト結果一覧

| ID | テスト名 | 結果 |
|----|---------|------|
| {テストID} | {テスト名} | ✅/❌ |
| ... | ... | ... |

## 失敗テスト詳細（該当する場合）

| ID | テスト名 | 失敗箇所 | 推定原因 |
|----|---------|---------|---------|
| {テストID} | {テスト名} | ステップX | 原因の説明 |
```

### Step 3-3: ユーザーへの最終報告

サマリーレポートの内容をユーザーに提示する。PASS/FAIL の総数、失敗テストがある場合はその一覧と推定原因を含める。
