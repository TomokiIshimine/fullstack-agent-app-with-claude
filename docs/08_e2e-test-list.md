# E2Eテスト一覧

**作成日:** 2025-10-30
**最終更新:** 2025-12-30
**バージョン:** 2.0
**対象システム:** フルスタックWebアプリケーション（AIエージェント機能付き）

---

## 1. はじめに

### 1.1 本ドキュメントの目的

本ドキュメントは、フルスタックWebアプリケーションのE2E（End-to-End）テストシナリオを一覧化します。ユーザーの実際の操作フローを再現し、アプリケーション全体の動作を検証するテストケースを定義します。

### 1.2 対象読者

- QAエンジニア
- 開発者全般（フロントエンド、バックエンド）
- テックリード、アーキテクト

**関連ドキュメント:**
- [テスト戦略書](./06_testing-strategy.md) - テストレベル、テストピラミッド
- [機能一覧](./03_feature-list.md) - テスト対象機能
- [システム構成設計書](./01_system-architecture.md) - システムアーキテクチャ
- [エージェント機能仕様](../specs/agent.md) - ツール呼び出し機能の仕様

---

> ⚠️ **重要: このドキュメントは計画ドキュメントです**
>
> このドキュメントは、将来のE2Eテスト実装のための**計画・設計書**です。
> **現時点ではE2Eテストは実装されていません。**
>
> **現在の状態:**
> - ✅ ユニットテスト (Vitest, pytest) - 実装済み
> - ✅ 統合テスト (pytest for API routes) - 実装済み
> - ❌ E2Eテスト (Playwright) - **未実装**
>
> **未実装の詳細:**
> - Playwrightはインストールされていません
> - E2Eテストファイル (`frontend/e2e/`) は存在しません
> - `test:e2e` スクリプトは定義されていません
> - CI/CDパイプラインでE2Eテストは実行されていません
>
> **現在の手動テスト方法:**
> - MCP Playwrightツールを使用した手動ブラウザテスト ([CLAUDE.md - Manual Testing](../CLAUDE.md#manual-testing-and-browser-automation) を参照)
> - ローカル環境での手動動作確認

---

## 2. E2Eテスト概要

### 2.1 E2Eテストの目的

E2Eテストは、アプリケーション全体（フロントエンド + バックエンド + データベース）を統合的にテストし、実際のユーザー体験を検証します。

**主な目的:**
- ユーザーの実際の操作フローが正しく動作することを確認
- システム全体の統合動作を検証
- クリティカルなビジネスフローが壊れていないことを保証
- リグレッション検知（既存機能の破壊を防止）

### 2.2 テストツール

| ツール | 用途 | 実装状況 |
|-------|------|---------|
| **Playwright** | ブラウザ自動化 | 未実装 |
| **MCP Playwright** | Claude Code統合 | 利用可能 |

### 2.3 テスト実行タイミング

| タイミング | 説明 |
|-----------|------|
| **プルリクエスト作成時** | クリティカルパステストのみ実行 |
| **mainブランチマージ前** | 全E2Eテストを実行 |
| **リリース前** | 全E2Eテストを実行 + 手動スモークテスト |
| **ローカル開発** | 影響範囲のテストを手動実行 |

---

## 3. テスト環境

### 3.1 環境構成

**テスト実行環境:**
```
ブラウザ（Playwright）
    ↓ HTTP
フロントエンド（React + Vite）
    ↓ REST API
バックエンド（Flask）
    ↓ SQL
データベース（MySQL）
    ↓
Redis（レート制限）
```

**前提条件:**
- Docker Composeでフルスタックが起動していること
- テスト用ユーザーが事前に作成されていること
- データベースが初期状態であること
- ANTHROPIC_API_KEYが設定されていること（AIチャットテスト用）

### 3.2 テストデータ

**テストユーザー:**
| ユーザー | メールアドレス | パスワード | ロール | 用途 |
|---------|--------------|----------|-------|------|
| Admin | `e2e-admin@example.com` | `Test123!` | admin | 管理者機能テスト |
| User A | `e2e-user-a@example.com` | `Test123!` | user | 基本フローテスト |
| User B | `e2e-user-b@example.com` | `Test123!` | user | クロスユーザーセキュリティテスト |

**テストデータのクリーンアップ:**
- 各テストケース実行前にテストデータを全削除
- テスト実行後もデータベースをクリーンアップ

---

## 4. E2Eテストシナリオ一覧

### 4.1 認証フロー

#### E2E-AUTH-001: ログイン成功フロー

**優先度:** ★★★（クリティカル）
**実装状況:** 未実装

**前提条件:**
- テストユーザー（User A）が登録済み

**テストステップ:**
1. ログイン画面（`/login`）にアクセス
2. メールアドレス: `e2e-user-a@example.com` を入力
3. パスワード: `Test123!` を入力
4. 「ログイン」ボタンをクリック

**期待結果:**
- ルート（`/`）経由でチャット画面（`/chat`）にリダイレクトされる
- ヘッダーにログアウトボタンが表示される
- 会話一覧とメッセージ入力欄が表示される
- ヘッダーにバージョン情報が表示される

---

#### E2E-AUTH-002: ログイン失敗（誤ったパスワード）

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- テストユーザー（User A）が登録済み

**テストステップ:**
1. ログイン画面（`/login`）にアクセス
2. メールアドレス: `e2e-user-a@example.com` を入力
3. パスワード: `WrongPassword123` を入力
4. 「ログイン」ボタンをクリック

**期待結果:**
- ログイン画面に留まる
- エラーメッセージ「メールアドレスまたはパスワードが正しくありません」が表示される
- 入力フィールドがクリアされない（再入力が容易）

---

#### E2E-AUTH-003: ログイン失敗（存在しないユーザー）

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**テストステップ:**
1. ログイン画面（`/login`）にアクセス
2. メールアドレス: `nonexistent@example.com` を入力
3. パスワード: `AnyPassword123` を入力
4. 「ログイン」ボタンをクリック

**期待結果:**
- ログイン画面に留まる
- エラーメッセージ「メールアドレスまたはパスワードが正しくありません」が表示される
- セキュリティ上、存在しないユーザーかどうかは明示しない

---

#### E2E-AUTH-004: ログイン失敗（入力バリデーション）

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**テストステップ:**
1. ログイン画面（`/login`）にアクセス
2. メールアドレス欄を空のまま
3. パスワード欄を空のまま
4. 「ログイン」ボタンをクリック

**期待結果:**
- バリデーションエラーメッセージが表示される
- APIリクエストが送信されない

---

#### E2E-AUTH-005: ログアウトフロー

**優先度:** ★★★（クリティカル）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面（`/chat`）にアクセス
2. ヘッダーの「ログアウト」ボタンをクリック

**期待結果:**
- ログイン画面（`/login`）にリダイレクトされる
- 再度 `/chat` や `/` にアクセスしようとすると、ログイン画面にリダイレクトされる
- トークンがクリアされている（認証が無効化）

---

#### E2E-AUTH-006: 未認証時のリダイレクト（チャット画面）

**優先度:** ★★★（クリティカル）
**実装状況:** 未実装

**前提条件:**
- ログインしていない状態

**テストステップ:**
1. ブラウザを起動
2. チャット画面（`/chat`）に直接アクセス

**期待結果:**
- ログイン画面（`/login`）にリダイレクトされる
- 保護されたコンテンツは表示されない

---

#### E2E-AUTH-007: 未認証時のリダイレクト（設定画面）

**優先度:** ★★★（クリティカル）
**実装状況:** 未実装

**前提条件:**
- ログインしていない状態

**テストステップ:**
1. ブラウザを起動
2. 設定画面（`/settings`）に直接アクセス

**期待結果:**
- ログイン画面（`/login`）にリダイレクトされる
- 保護されたコンテンツは表示されない

---

#### E2E-AUTH-008: 未認証時のリダイレクト（管理画面）

**優先度:** ★★★（クリティカル）
**実装状況:** 未実装

**前提条件:**
- ログインしていない状態

**テストステップ:**
1. ブラウザを起動
2. ユーザー管理画面（`/admin/users`）に直接アクセス

**期待結果:**
- ログイン画面（`/login`）にリダイレクトされる
- 保護されたコンテンツは表示されない

---

#### E2E-AUTH-009: 一般ユーザーの管理画面アクセス拒否

**優先度:** ★★★（クリティカル）
**実装状況:** 未実装

**前提条件:**
- 一般ユーザー（User A）でログイン済み

**テストステップ:**
1. ユーザー管理画面（`/admin/users`）に直接アクセス

**期待結果:**
- アクセス拒否エラーが表示される、またはチャット画面にリダイレクトされる
- 管理者専用コンテンツは表示されない

---

#### E2E-AUTH-010: トークン自動更新

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み
- アクセストークンの有効期限が切れている（テスト用に短い有効期限を設定）

**テストステップ:**
1. トークンが期限切れになるまで待機
2. チャット画面で新しいメッセージを送信

**期待結果:**
- 自動的にトークンがリフレッシュされる
- メッセージが正常に送信される
- ユーザーはログアウトされない

---

### 4.2 AIチャット機能

#### E2E-CHAT-001: 新規会話の作成

**優先度:** ★★★（クリティカル）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面（`/chat`）にアクセス
2. メッセージ入力欄に「こんにちは」と入力
3. 送信ボタンをクリック

**期待結果:**
- URLが `/chat/{uuid}` 形式に遷移する
- 会話一覧に新しい会話が追加される
- ユーザーメッセージ「こんにちは」が表示される
- AI応答がストリーミング表示される
- AI応答完了後、メッセージが完全に表示される

---

#### E2E-CHAT-002: 既存会話へのメッセージ送信

**優先度:** ★★★（クリティカル）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み
- 既存の会話が1つ以上存在する

**テストステップ:**
1. 会話一覧から既存の会話を選択
2. メッセージ入力欄に「追加の質問です」と入力
3. 送信ボタンをクリック

**期待結果:**
- 選択した会話のスレッドに新しいメッセージが追加される
- AI応答がストリーミング表示される
- 会話一覧の順序が更新される（最新の会話が上に）

---

#### E2E-CHAT-003: 会話の削除

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み
- 既存の会話が1つ以上存在する

**テストステップ:**
1. 会話一覧から削除したい会話を選択
2. 削除ボタンをクリック
3. 確認ダイアログで「削除」をクリック

**期待結果:**
- 会話が会話一覧から削除される
- URLが `/chat` に遷移する
- 成功メッセージが表示される

---

#### E2E-CHAT-004: 会話の切り替え

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み
- 既存の会話が2つ以上存在する

**テストステップ:**
1. 会話一覧から1つ目の会話を選択
2. メッセージ履歴が表示されることを確認
3. 会話一覧から2つ目の会話を選択

**期待結果:**
- 2つ目の会話のメッセージ履歴に切り替わる
- URLが対応する `/chat/{uuid}` に変更される

---

#### E2E-CHAT-005: 空メッセージの送信防止

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. メッセージ入力欄を空のまま送信ボタンをクリック

**期待結果:**
- メッセージは送信されない
- 送信ボタンが無効化されている

---

#### E2E-CHAT-006: 長文メッセージの送信

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. 1000文字以上の長文メッセージを入力
3. 送信ボタンをクリック

**期待結果:**
- メッセージが正常に送信される
- AI応答が正常に表示される
- UIが崩れない

---

### 4.3 エージェント機能（ツール呼び出し）

#### E2E-AGENT-001: 計算ツールの使用（加算）

**優先度:** ★★★（クリティカル）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. メッセージ入力欄に「123 + 456 を計算してください」と入力
3. 送信ボタンをクリック

**期待結果:**
- ツール呼び出しがUI上に表示される
- ツール名「add」が表示される
- ツールの入力（123, 456）がエクスパンダーで確認可能
- ツールの出力（579）がエクスパンダーで確認可能
- AIの最終応答に計算結果が含まれる

---

#### E2E-AGENT-002: 計算ツールの使用（減算）

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. メッセージ入力欄に「1000 - 350 を計算してください」と入力
3. 送信ボタンをクリック

**期待結果:**
- ツール呼び出し「subtract」が表示される
- 計算結果（650）が正しく表示される

---

#### E2E-AGENT-003: 計算ツールの使用（乗算）

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. メッセージ入力欄に「25 × 4 を計算してください」と入力
3. 送信ボタンをクリック

**期待結果:**
- ツール呼び出し「multiply」が表示される
- 計算結果（100）が正しく表示される

---

#### E2E-AGENT-004: 計算ツールの使用（除算）

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. メッセージ入力欄に「100 ÷ 4 を計算してください」と入力
3. 送信ボタンをクリック

**期待結果:**
- ツール呼び出し「divide」が表示される
- 計算結果（25）が正しく表示される

---

#### E2E-AGENT-005: 複数ツールの連続呼び出し

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. メッセージ入力欄に「(10 + 5) × 3 を計算してください」と入力
3. 送信ボタンをクリック

**期待結果:**
- 複数のツール呼び出しがUI上に表示される
- 各ツールの入出力がエクスパンダーで確認可能
- 最終計算結果（45）が正しく表示される

---

#### E2E-AGENT-006: ツール呼び出しエクスパンダーの展開/折りたたみ

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み
- ツールを使用した会話が存在する

**テストステップ:**
1. ツールを使用した会話を表示
2. ツール呼び出し表示をクリックして展開
3. 入力と出力の詳細を確認
4. 再度クリックして折りたたみ

**期待結果:**
- デフォルトでは折りたたまれた状態
- クリックで展開され、ツール名・入力JSON・出力結果が表示される
- 再度クリックで折りたたまれる

---

#### E2E-AGENT-007: ツールを使わない通常会話

**優先度:** ★★★（クリティカル）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. メッセージ入力欄に「日本の首都はどこですか？」と入力
3. 送信ボタンをクリック

**期待結果:**
- ツール呼び出しが行われない
- AI応答が直接表示される
- 正常に会話が完了する

---

#### E2E-AGENT-008: ツール呼び出し履歴の永続化確認

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み
- 計算ツールを使用した会話が存在する

**テストステップ:**
1. ページをリロード
2. 会話一覧から該当の会話を選択

**期待結果:**
- ツール呼び出し履歴が正しく表示される
- ツールの入出力がエクスパンダーで確認可能

---

### 4.4 設定機能

#### E2E-SETTINGS-001: プロフィール更新（名前の変更）

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. 設定画面（`/settings`）にアクセス
2. 名前を「テストユーザーA更新」に変更
3. 「更新」ボタンをクリック

**期待結果:**
- 成功メッセージ「プロフィールを更新しました」が表示される
- フォームに更新後の名前が反映される

---

#### E2E-SETTINGS-002: プロフィール更新（メールアドレスの変更）

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. 設定画面（`/settings`）にアクセス
2. メールアドレスを `e2e-user-a-updated@example.com` に変更
3. 「更新」ボタンをクリック

**期待結果:**
- 成功メッセージ「プロフィールを更新しました」が表示される
- フォームに更新後のメールアドレスが反映される

---

#### E2E-SETTINGS-003: プロフィール更新（バリデーションエラー）

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. 設定画面（`/settings`）にアクセス
2. メールアドレスを無効な形式（`invalid-email`）に変更
3. 「更新」ボタンをクリック

**期待結果:**
- バリデーションエラーメッセージが表示される
- プロフィールは更新されない

---

#### E2E-SETTINGS-004: パスワード変更成功

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. 設定画面（`/settings`）にアクセス
2. 現在のパスワード: `Test123!` を入力
3. 新しいパスワード: `NewTest123!` を入力
4. 新しいパスワード（確認）: `NewTest123!` を入力
5. 「パスワードを変更」ボタンをクリック

**期待結果:**
- 成功メッセージ「パスワードを変更しました」が表示される
- 以降は新しいパスワード `NewTest123!` でログインできる

---

#### E2E-SETTINGS-005: パスワード変更失敗（現在のパスワード不一致）

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. 設定画面（`/settings`）にアクセス
2. 現在のパスワード: `WrongPassword123` を入力
3. 新しいパスワード: `NewTest123!` を入力
4. 新しいパスワード（確認）: `NewTest123!` を入力
5. 「パスワードを変更」ボタンをクリック

**期待結果:**
- エラーメッセージが表示される
- パスワードは変更されない

---

#### E2E-SETTINGS-006: パスワード変更失敗（新パスワードの確認不一致）

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. 設定画面（`/settings`）にアクセス
2. 現在のパスワード: `Test123!` を入力
3. 新しいパスワード: `NewTest123!` を入力
4. 新しいパスワード（確認）: `DifferentPassword123!` を入力
5. 「パスワードを変更」ボタンをクリック

**期待結果:**
- バリデーションエラーメッセージが表示される
- パスワードは変更されない

---

#### E2E-SETTINGS-007: パスワード変更失敗（パスワード強度不足）

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. 設定画面（`/settings`）にアクセス
2. 現在のパスワード: `Test123!` を入力
3. 新しいパスワード: `weak` を入力
4. 新しいパスワード（確認）: `weak` を入力
5. 「パスワードを変更」ボタンをクリック

**期待結果:**
- バリデーションエラーメッセージが表示される（8文字以上必要）
- パスワードは変更されない

---

### 4.5 管理者機能

#### E2E-ADMIN-001: ユーザー一覧の表示

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- 管理者ユーザー（Admin）でログイン済み

**テストステップ:**
1. ユーザー管理画面（`/admin/users`）にアクセス
2. ユーザー一覧が表示されるまで待機

**期待結果:**
- ユーザーの一覧（メールアドレス、ロール、作成日）が表示される
- 自分自身（管理者）には削除ボタンが表示されない
- 一般ユーザーには削除ボタンが表示される

---

#### E2E-ADMIN-002: 新規ユーザー作成

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- 管理者ユーザー（Admin）でログイン済み

**テストステップ:**
1. ユーザー管理画面（`/admin/users`）にアクセス
2. 「+ 新規ユーザー追加」をクリック
3. 名前: `新規テストユーザー` を入力
4. メールアドレス: `new-test-user@example.com` を入力
5. ロール: `user` を選択
6. 「作成」ボタンをクリック

**期待結果:**
- 一覧に新しいユーザーが追加される
- 初期パスワードがモーダルで表示される
- 成功メッセージが表示される

---

#### E2E-ADMIN-003: 新規ユーザー作成失敗（重複メールアドレス）

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- 管理者ユーザー（Admin）でログイン済み
- User Aが既に存在する

**テストステップ:**
1. ユーザー管理画面にアクセス
2. 「+ 新規ユーザー追加」をクリック
3. メールアドレス: `e2e-user-a@example.com`（既存）を入力
4. その他必須項目を入力
5. 「作成」ボタンをクリック

**期待結果:**
- エラーメッセージ「このメールアドレスは既に使用されています」が表示される
- ユーザーは作成されない

---

#### E2E-ADMIN-004: 一般ユーザー削除

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- 管理者ユーザー（Admin）でログイン済み
- 削除対象の一般ユーザー（User B）が存在する

**テストステップ:**
1. ユーザー管理画面（`/admin/users`）にアクセス
2. User Bの「削除」ボタンをクリック
3. 確認モーダルで「削除」を確定

**期待結果:**
- User Bが一覧から削除される
- 成功メッセージが表示される

---

#### E2E-ADMIN-005: 管理者ユーザー削除の防止

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- 管理者ユーザー（Admin）でログイン済み

**テストステップ:**
1. ユーザー管理画面（`/admin/users`）にアクセス
2. 自分自身（Admin）の行を確認

**期待結果:**
- 自分自身には削除ボタンが表示されない
- または削除ボタンが無効化されている

---

### 4.6 ナビゲーション

#### E2E-NAV-001: サイドバーナビゲーション（チャット → 設定）

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面（`/chat`）にアクセス
2. サイドバーまたはヘッダーの「設定」リンクをクリック

**期待結果:**
- 設定画面（`/settings`）に遷移する
- 設定フォームが表示される

---

#### E2E-NAV-002: サイドバーナビゲーション（設定 → チャット）

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. 設定画面（`/settings`）にアクセス
2. サイドバーまたはヘッダーの「チャット」リンクをクリック

**期待結果:**
- チャット画面（`/chat`）に遷移する
- 会話一覧が表示される

---

#### E2E-NAV-003: 管理者メニュー表示（管理者のみ）

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- 管理者ユーザー（Admin）でログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. ナビゲーションを確認

**期待結果:**
- 「ユーザー管理」メニューが表示される

---

#### E2E-NAV-004: 管理者メニュー非表示（一般ユーザー）

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- 一般ユーザー（User A）でログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. ナビゲーションを確認

**期待結果:**
- 「ユーザー管理」メニューが表示されない

---

### 4.7 エラーハンドリング

#### E2E-ERROR-001: ネットワークエラー時の動作

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. ネットワークをオフラインに設定（Playwrightの機能を使用）
3. メッセージを送信

**期待結果:**
- エラーメッセージが表示される
- アプリケーションがクラッシュしない
- ネットワーク復旧後、再試行が可能

---

#### E2E-ERROR-002: サーバーエラー時の動作

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. バックエンドサーバーを停止（またはモックで500エラーを返す）
3. メッセージを送信

**期待結果:**
- エラーメッセージが表示される
- アプリケーションがクラッシュしない

---

#### E2E-ERROR-003: 存在しない会話へのアクセス

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. 存在しないUUIDで会話ページにアクセス（`/chat/00000000-0000-0000-0000-000000000000`）

**期待結果:**
- エラーメッセージが表示される
- チャット画面（`/chat`）にリダイレクトされる

---

#### E2E-ERROR-004: 他ユーザーの会話へのアクセス

**優先度:** ★★☆（重要）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み
- User Bが作成した会話が存在する

**テストステップ:**
1. User Bの会話UUIDを使ってアクセス

**期待結果:**
- アクセス拒否エラーが表示される
- User Bの会話内容は表示されない

---

### 4.8 レスポンシブデザイン

#### E2E-RESPONSIVE-001: モバイル表示（ログイン画面）

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**テストステップ:**
1. ビューポートをモバイルサイズ（375×667）に設定
2. ログイン画面にアクセス

**期待結果:**
- フォームが画面幅に収まる
- タップターゲットが44px以上
- 入力フィールドが使いやすいサイズ

---

#### E2E-RESPONSIVE-002: モバイル表示（チャット画面）

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. ビューポートをモバイルサイズ（375×667）に設定
2. チャット画面にアクセス

**期待結果:**
- 会話一覧とチャットエリアが適切にレイアウトされる
- メッセージ入力欄が使いやすい
- バージョン表示は非表示

---

#### E2E-RESPONSIVE-003: タブレット表示（チャット画面）

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. ビューポートをタブレットサイズ（768×1024）に設定
2. チャット画面にアクセス

**期待結果:**
- サイドバーと本文エリアが適切に表示される
- UIが崩れない

---

### 4.9 システム監視

#### E2E-HEALTH-001: ヘルスチェック

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**テストステップ:**
1. `/api/health` エンドポイントにアクセス

**期待結果:**
- ステータス200が返る
- `{"status": "healthy", "database": "connected", "version": "..."}` 形式のJSONが返る

---

#### E2E-HEALTH-002: バージョン表示

**優先度:** ★☆☆（通常）
**実装状況:** 未実装

**前提条件:**
- User Aでログイン済み

**テストステップ:**
1. チャット画面にアクセス
2. ヘッダー右上を確認

**期待結果:**
- アプリケーションバージョンが表示される

---

## 5. テスト優先度マトリクス

### 5.1 優先度別テストケース数

| 優先度 | テストケース数 | 説明 |
|-------|-------------|------|
| ★★★（クリティカル） | 14 | 必須実行、リリースブロッカー |
| ★★☆（重要） | 24 | 重要機能、プルリクエスト時に実行 |
| ★☆☆（通常） | 12 | 定期的に実行、リリース前に実行 |

### 5.2 機能別テストケース数

| 機能カテゴリ | テストケース数 |
|------------|-------------|
| 認証フロー | 10 |
| AIチャット | 6 |
| エージェント機能 | 8 |
| 設定 | 7 |
| 管理者機能 | 5 |
| ナビゲーション | 4 |
| エラーハンドリング | 4 |
| レスポンシブデザイン | 3 |
| システム監視 | 2 |
| **合計** | **50** |

---

## 6. テスト実装ガイド

> **注記:** 現時点ではE2Eテストは未実装です。以下は導入時の想定例として記載しています。

### 6.1 テストファイル構成（推奨）

```
frontend/
  e2e/
    tests/
      auth/
        login.spec.ts              # E2E-AUTH-001 ~ E2E-AUTH-010
      chat/
        conversations.spec.ts      # E2E-CHAT-001 ~ E2E-CHAT-006
      agent/
        tool-calls.spec.ts         # E2E-AGENT-001 ~ E2E-AGENT-008
      settings/
        profile.spec.ts            # E2E-SETTINGS-001 ~ E2E-SETTINGS-003
        password.spec.ts           # E2E-SETTINGS-004 ~ E2E-SETTINGS-007
      admin/
        user-management.spec.ts    # E2E-ADMIN-001 ~ E2E-ADMIN-005
      navigation/
        navigation.spec.ts         # E2E-NAV-001 ~ E2E-NAV-004
      errors/
        error-handling.spec.ts     # E2E-ERROR-001 ~ E2E-ERROR-004
      responsive/
        responsive.spec.ts         # E2E-RESPONSIVE-001 ~ E2E-RESPONSIVE-003
      health/
        health.spec.ts             # E2E-HEALTH-001 ~ E2E-HEALTH-002
    fixtures/
      auth.ts                      # 認証ヘルパー関数
      test-data.ts                 # テストデータ定義
    playwright.config.ts
```

### 6.2 実装例（Playwright）

#### ログインヘルパー関数

```typescript
// e2e/fixtures/auth.ts
import { Page } from '@playwright/test';

export async function login(page: Page, email: string, password: string) {
  await page.goto('/login');
  await page.fill('input[type="email"]', email);
  await page.fill('input[type="password"]', password);
  await page.click('button[type="submit"]');
  await page.waitForURL('/chat');
}

export async function loginAsAdmin(page: Page) {
  await login(page, 'e2e-admin@example.com', 'Test123!');
}

export async function loginAsUser(page: Page) {
  await login(page, 'e2e-user-a@example.com', 'Test123!');
}
```

#### テストケース例（認証）

```typescript
// e2e/tests/auth/login.spec.ts
import { test, expect } from '@playwright/test';
import { login } from '../../fixtures/auth';

test('E2E-AUTH-001: ログイン成功フロー', async ({ page }) => {
  await login(page, 'e2e-user-a@example.com', 'Test123!');

  // チャット画面にリダイレクト
  await expect(page).toHaveURL('/chat');

  // ログアウトボタンが表示される
  await expect(page.locator('button:has-text("ログアウト")')).toBeVisible();
});

test('E2E-AUTH-002: ログイン失敗（誤ったパスワード）', async ({ page }) => {
  await page.goto('/login');
  await page.fill('input[type="email"]', 'e2e-user-a@example.com');
  await page.fill('input[type="password"]', 'WrongPassword');
  await page.click('button[type="submit"]');

  // エラーメッセージが表示される
  await expect(page.locator('text=メールアドレスまたはパスワードが正しくありません')).toBeVisible();

  // ログイン画面に留まる
  await expect(page).toHaveURL('/login');
});
```

#### テストケース例（エージェント機能）

```typescript
// e2e/tests/agent/tool-calls.spec.ts
import { test, expect } from '@playwright/test';
import { loginAsUser } from '../../fixtures/auth';

test('E2E-AGENT-001: 計算ツールの使用（加算）', async ({ page }) => {
  await loginAsUser(page);

  // 新規会話を開始
  await page.goto('/chat');
  await page.fill('textarea[placeholder*="メッセージ"]', '123 + 456 を計算してください');
  await page.click('button[type="submit"]');

  // ツール呼び出しが表示されるまで待機
  await expect(page.locator('text=add')).toBeVisible({ timeout: 30000 });

  // ツール結果が表示される
  await expect(page.locator('text=579')).toBeVisible();
});

test('E2E-AGENT-006: ツール呼び出しエクスパンダーの展開/折りたたみ', async ({ page }) => {
  await loginAsUser(page);

  // ツールを使用した会話を作成
  await page.goto('/chat');
  await page.fill('textarea[placeholder*="メッセージ"]', '10 + 20 を計算してください');
  await page.click('button[type="submit"]');

  // ツール呼び出しが完了するまで待機
  await expect(page.locator('text=30')).toBeVisible({ timeout: 30000 });

  // エクスパンダーをクリックして展開
  const expander = page.locator('[data-testid="tool-call-expander"]');
  await expander.click();

  // 入力と出力の詳細が表示される
  await expect(page.locator('text="a": 10')).toBeVisible();
  await expect(page.locator('text="b": 20')).toBeVisible();
});
```

### 6.3 テスト実行コマンド

> **注記:** `test:e2e` スクリプトは現時点で未定義です。導入後の想定コマンドとして記載しています。

**すべてのE2Eテストを実行:**
```bash
pnpm --dir frontend run test:e2e
```

**特定のテストファイルを実行:**
```bash
pnpm --dir frontend run test:e2e -- auth/login.spec.ts
```

**クリティカルテストのみ実行:**
```bash
pnpm --dir frontend run test:e2e -- --grep "★★★"
```

**ヘッドレスモードで実行:**
```bash
pnpm --dir frontend run test:e2e:headless
```

**デバッグモード（ブラウザを表示）:**
```bash
pnpm --dir frontend run test:e2e:debug
```

---

## 7. テストデータ管理

### 7.1 テストユーザーのセットアップ

**セットアップスクリプト:**
```bash
# 管理者ユーザーを作成
make db-create-user EMAIL=e2e-admin@example.com PASSWORD=Test123! ROLE=admin

# テストユーザーを作成
make db-create-user EMAIL=e2e-user-a@example.com PASSWORD=Test123!
make db-create-user EMAIL=e2e-user-b@example.com PASSWORD=Test123!
```

### 7.2 テストデータのクリーンアップ

**各テスト実行前:**
- データベースをリセットするか、テストユーザーのデータを削除
- テスト実行後もクリーンアップを実施し、テストの独立性を確保

---

## 8. CI/CD統合

### 8.1 GitHub Actions設定例

```yaml
# .github/workflows/e2e-tests.yml
name: E2E Tests

on:
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Start Docker Compose
        run: make up

      - name: Wait for services
        run: |
          timeout 120 bash -c 'until curl -f http://localhost:5174; do sleep 1; done'

      - name: Setup test data
        run: |
          make db-create-user EMAIL=e2e-admin@example.com PASSWORD=Test123! ROLE=admin
          make db-create-user EMAIL=e2e-user-a@example.com PASSWORD=Test123!
          make db-create-user EMAIL=e2e-user-b@example.com PASSWORD=Test123!

      - name: Run E2E tests
        run: pnpm --dir frontend run test:e2e:ci
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: frontend/playwright-report/
```

---

## 9. 今後の拡張予定

### 9.1 追加予定のテストシナリオ

| カテゴリ | シナリオ | 説明 |
|---------|---------|------|
| パフォーマンス | ページ読み込み時間 | 3秒以内の読み込み |
| パフォーマンス | API応答時間 | 1秒以内の応答 |
| アクセシビリティ | キーボード操作 | Tab/Enterでの操作可能性 |
| アクセシビリティ | スクリーンリーダー | ARIA属性の適切な設定 |
| 国際化 | 多言語対応 | 将来的な多言語サポート |

### 9.2 新ツール追加時のテスト

新しいツールがエージェントに追加された場合、以下のテストを追加：
1. ツールの基本動作テスト
2. ツールのエラーハンドリングテスト
3. ツール呼び出し履歴の永続化テスト
4. UIでのツール表示テスト

---

## 10. 関連ドキュメント

- [テスト戦略書](./06_testing-strategy.md) - テストピラミッド、テストレベル
- [機能一覧](./03_feature-list.md) - 実装済み機能一覧
- [システム構成設計書](./01_system-architecture.md) - システムアーキテクチャ
- [認証・認可設計書](./02_authentication-authorization.md) - 認証フロー、セキュリティ
- [エージェント機能仕様](../specs/agent.md) - ツール呼び出し機能

---

**END OF DOCUMENT**
